import './polyfills.server.mjs';
import{b as w}from"./chunk-YLHPT32Y.mjs";import{m as k}from"./chunk-CIE2ZWBG.mjs";import{r as b}from"./chunk-YEWAR4WW.mjs";import{I as u,N as g,Pa as h,S as m,T as c,j as o,n as i,v as a,va as v}from"./chunk-D7ZWPOEP.mjs";import{a as d,b as f}from"./chunk-5XUXGTUW.mjs";var n=class extends Error{};n.prototype.name="InvalidTokenError";function T(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function E(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return T(e)}catch{return atob(e)}}function U(s,e){if(typeof s!="string")throw new n("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new n(`Invalid token specified: missing part #${t+1}`);let p;try{p=E(r)}catch(l){throw new n(`Invalid token specified: invalid base64 for part #${t+1} (${l.message})`)}try{return JSON.parse(p)}catch(l){throw new n(`Invalid token specified: invalid json for part #${t+1} (${l.message})`)}}var S=class s{TOKEN_KEY="auth_token";USER_KEY="auth_user";apiService=c(w);router=c(k);isBrowser;isAuthenticated=h(!1);currentUser=h(null);constructor(e){this.isBrowser=b(e),this.isBrowser&&(this.isAuthenticated.set(this.hasValidToken()),this.currentUser.set(this.getUserFromStorage()))}login(e){return this.apiService.post("auth/login",e).pipe(u(t=>{if(t.status==="success"){this.storeToken(t.data.authorization);let r=this.getUserFromToken();r?(this.storeUser(r),this.currentUser.set(r)):(this.storeUser(t.data.user),this.currentUser.set(t.data.user)),this.isAuthenticated.set(!0)}}),i(t=>t.status==="success"),a(()=>o(!1)))}register(e){return this.apiService.post("auth/register",e).pipe(u(t=>{if(t.status==="success"){this.storeToken(t.data.authorization);let r=this.getUserFromToken();r?(this.storeUser(r),this.currentUser.set(r)):(this.storeUser(t.data.user),this.currentUser.set(t.data.user)),this.isAuthenticated.set(!0)}}),i(t=>t.status==="success"),a(()=>o(!1)))}logout(){return this.isAuthenticated()?this.apiService.post("auth/logout",{}).pipe(u(()=>this.clearAuth()),i(()=>!0),a(()=>(this.clearAuth(),o(!0)))):(this.clearAuth(),o(!0))}refreshToken(){return this.apiService.post("auth/refresh",{}).pipe(u(e=>{e.status==="success"&&this.storeToken(e.data.authorization)}),i(e=>e.status==="success"),a(()=>o(!1)))}loadProfile(){return this.apiService.get("auth/profile").pipe(u(e=>{e.status==="success"&&e.data.user&&(this.storeUser(e.data.user),this.currentUser.set(e.data.user))}),i(e=>e.data.user),a(()=>o(null)))}forgotPassword(e){return this.apiService.post("auth/forgot-password",{email:e}).pipe(i(t=>t),a(t=>{throw console.error("Error enviando correo de recuperaci\xF3n:",t),t}))}validateResetToken(e,t){return this.apiService.post("auth/validate-reset-token",{token:e,email:t}).pipe(i(r=>r),a(r=>{throw console.error("Error validando token:",r),r}))}resetPassword(e){return this.apiService.post("auth/reset-password",e).pipe(i(t=>t),a(t=>{throw console.error("Error restableciendo contrase\xF1a:",t),t}))}clearAuth(){this.isBrowser&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)),this.isAuthenticated.set(!1),this.currentUser.set(null),this.router.navigate(["/auth/login"])}storeToken(e){this.isBrowser&&localStorage.setItem(this.TOKEN_KEY,JSON.stringify(f(d({},e),{expires_at:new Date().getTime()+e.expires_in*1e3})))}storeUser(e){e&&this.isBrowser&&localStorage.setItem(this.USER_KEY,JSON.stringify(e))}getToken(){if(!this.isBrowser)return null;try{let e=localStorage.getItem(this.TOKEN_KEY);return e?JSON.parse(e).access_token:null}catch{return null}}getUserFromStorage(){if(!this.isBrowser)return null;try{let e=this.getUserFromToken();if(e)return e;let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}catch{return null}}hasValidToken(){if(!this.isBrowser)return!1;try{let e=localStorage.getItem(this.TOKEN_KEY);if(!e)return!1;let t=JSON.parse(e);return t.expires_at&&new Date().getTime()>t.expires_at?(this.clearAuth(),!1):!0}catch{return this.clearAuth(),!1}}getUserFromToken(){if(!this.isBrowser)return null;try{let e=this.getToken();if(!e)return null;let t=U(e);return t&&t.id&&t.name&&t.email&&t.rol?{id:t.id,name:t.name,email:t.email,rol:t.rol,created_at:t.created_at||"",updated_at:t.updated_at||""}:null}catch(e){return console.error("Error al decodificar el token JWT",e),null}}static \u0275fac=function(t){return new(t||s)(m(v))};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};export{S as a};
